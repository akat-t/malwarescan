{% extends 'admin/master.html' %}

{% block body %}
{{ super() }}
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-users fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge">{{ clients|length }}</div>
                                    <div>Enrolled Clients</div>
                                </div>
                            </div>
                        </div>
                        <a href="{{ url_for('clients.index_view') }}">
                            <div class="panel-footer">
                                <span class="pull-left">View Details</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-green">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-tasks fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge">{{ evals|length }}</div>
                                    <div>Total Evaluations</div>
                                </div>
                            </div>
                        </div>
                        <a href="{{ url_for('evals.index_view') }}">
                            <div class="panel-footer">
                                <span class="pull-left">View Details</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-yellow">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-copy fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge">{{ files|length }}</div>
                                    <div>Unique Files</div>
                                </div>
                            </div>
                        </div>
                        <a href="{{ url_for('files.index_view') }}">
                            <div class="panel-footer">
                                <span class="pull-left">View Details</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-red">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-shield fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge">{{ threats }}</div>
                                    <div>Threats Found</div>
                                </div>
                            </div>
                        </div>
                        <a href="{{ url_for('files.index_view', flt2_23=5) }}">
                            <div class="panel-footer">
                                <span class="pull-left">View Details</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <canvas id="pieClients" width="400" height="400"></canvas>
                </div>
                <!-- /.col -->
                <div class="col-lg-3 col-md-6">
                    <canvas id="pieEvals" width="400" height="400"></canvas>
                </div>
                <!-- /.col -->
                <div class="col-lg-3 col-md-6">
                    <canvas id="pieFiles" width="400" height="400"></canvas>
                </div>
                <!-- /.col -->
                <div class="col-lg-3 col-md-6">
                    <canvas id="pieThreats" width="400" height="400"></canvas>
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
            {% block details %}
            {% endblock details %}
{% endblock body %}

{% block tail %}
{{ super() }}
<script type="text/javascript">
    addEventListener('load', function(event) { PR.prettyPrint(); }, false);
    // {# set topX = 10 #}
    // Initialize pie data
    var cLabels = [];
    var cData = [];
    var cColors = randomColor({count: {{topX}}, hue: "blue"});
    var eLabels = [];
    var eData = [];
    var eColors = randomColor({count: {{topX}}, hue: "green"});
    var fLabels = [];
    var fData = [];
    var fColors = randomColor({count: {{topX}}, hue: "orange"});
    var tLabels = [];
    var tData = [];
    var tColors = randomColor({count: {{topX}}, hue: "red"});
    {% set top10_clients = [] %}
    {%- for item in clients %}
      // {{- top10_clients.append({"name": item.x509_cname, "count": item.evals|length}) }}
    {% endfor -%}
    {%- for item in (top10_clients|sort(attribute='count', reverse = True))[:topX] %}
    cLabels.push("{{- item.name -}}");
    cData.push("{{- item.count -}}");
    {% endfor -%}
    // Malicious evals chart
    {%- set top10_evals = [] -%}
    {%- for grouper, list in evals|selectattr("score", "greaterthan", 5)|list|groupby('client.x509_cname') %}
      // {{- top10_evals.append({"name": grouper, "count": list|length}) }}
    {% endfor %}
    {%- for item in (top10_evals|sort(attribute='count', reverse = True))[:topX] %}
    eLabels.push("{{- item.name -}}");
    eData.push("{{- item.count -}}");
    {% endfor -%}
    // Files by mimetype chart
    {%- set top10_files = [] -%}
    {%- for grouper, list in files|groupby('mtype') %}
      // {{- top10_files.append({"name": grouper, "count": list|length}) }}
    {% endfor %}
    {%- for item in (top10_files|sort(attribute='count', reverse = True))[:topX] %}
    fLabels.push("{{- item.name -}}");
    fData.push("{{- item.count -}}");
    {% endfor -%}
    // Malicious files chart
    {%- set top10_threats = [] -%}
    {%- for grouper, list in files|selectattr("score", "greaterthan", 5)|list|groupby('message') %}
      // {{- top10_threats.append({"name": grouper, "count": list|length}) }}
    {% endfor %}
    {%- for item in (top10_threats|sort(attribute='count', reverse = True))[:topX] %}
    tLabels.push("{{- item.name -}}");
    tData.push("{{- item.count -}}");
    {% endfor -%}
    // instaniate chart data
    var clientsData = {labels: cLabels, datasets: [{label: "# of Evaluations (count)", backgroundColor: cColors, data: cData}]};
    var evalsData = {labels: eLabels, datasets: [{label: "# of Evaluations (count)", backgroundColor: eColors, data: eData}]};
    var filesData = {labels: fLabels, datasets: [{label: "# of Evaluations (count)", backgroundColor: fColors, data: fData}]};
    var threatsData = {labels: tLabels, datasets: [{label: "# of Evaluations (count)", backgroundColor: tColors, data: tData}]};
    var cCtx = document.getElementById('pieClients').getContext('2d');
    var eCtx = document.getElementById('pieEvals').getContext('2d');
    var fCtx = document.getElementById('pieFiles').getContext('2d');
    var tCtx = document.getElementById('pieThreats').getContext('2d');
    new Chart(cCtx, {type: 'pie', data: clientsData,
                    options: {
                        title: {display: true, text: 'TOP {{topX}} Clients by # of Evaluations '},
                        legend: {display: false, position: 'bottom'}
                    }});
    new Chart(eCtx, {type: 'pie', data: evalsData,
                    options: {
                        title: {display: true, text: 'TOP {{topX}} Clients by # of Malicious Evaluations '},
                        legend: {display: false, position: 'bottom'}
                    }});
    new Chart(fCtx, {type: 'pie', data: filesData,
                    options: {
                        title: {display: true, text: 'TOP {{topX}} MIME Types by # of Files '},
                        legend: {display: false, position: 'bottom'}
                    }});
    new Chart(tCtx, {type: 'pie', data: threatsData,
                    options: {
                        title: {display: true, text: 'TOP {{topX}} Threats by # of Files '},
                        legend: {display: false, position: 'bottom'}
                    }});
</script>
{% endblock tail %}
